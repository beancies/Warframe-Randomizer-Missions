<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tenno Progression Matrix v2</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --accent: #2ea043; --btn: #21262d; --highlight: #58a6ff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 800px; width: 100%; }
        .upload-zone { border: 2px dashed #30363d; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 20px; cursor: pointer; }
        .btn-roll { background: var(--highlight); color: white; border: none; padding: 15px 30px; border-radius: 6px; font-weight: bold; width: 100%; cursor: pointer; font-size: 1.1em; }
        #result { background: var(--card); border: 1px solid #30363d; padding: 25px; border-radius: 12px; margin-top: 20px; display: none; border-left: 8px solid var(--highlight); }
        .category { text-transform: uppercase; font-size: 0.8em; color: #8b949e; letter-spacing: 1px; }
        .target { font-size: 2em; font-weight: bold; margin: 10px 0; }
        .location { color: var(--accent); font-family: monospace; font-size: 1.1em; }
        .reason { margin-top: 15px; padding: 10px; background: rgba(88, 166, 255, 0.1); border-radius: 4px; border-left: 3px solid var(--highlight); }
    </style>
</head>
<body>

<div class="container">
    <h1>Progression Matrix v2</h1>
    <div class="upload-zone" id="dropZone">
        <p id="fileStatus">Drop <strong>AlecaFrame JSON</strong> here to Sync</p>
        <input type="file" id="fileInput" accept=".json">
    </div>

    <button class="btn-roll" onclick="generateObjective()">GENERATE OBJECTIVE</button>

    <div id="result">
        <div class="category" id="cCat">Category</div>
        <div class="target" id="cName">Target</div>
        <div class="location" id="cLoc">Location</div>
        <div class="reason" id="cReason">Reason</div>
    </div>
</div>

<script>
    // --- DATABASE: NON-RELIC ITEMS (Truncated for brevity, same as before) ---
    const DB_FRAMES = { "ATLAS": "Jordas Precept", "BARUUK": "Vox Solaris", "CALIBAN": "Narmer Bounties", "CITRINE": "Tyana Pass", "DAGATH": "Abyssal Zone", "DANTE": "Armatus", "EMBER": "Tethys", "EXCALIBUR": "War (Mars)", "FROST": "Exta", "GAUSS": "Kelpie", "GRENDEL": "Arbitration", "GYRE": "Zariman", "HARROW": "Defection", "HILDRYN": "Exploiter Orb", "HYDROID": "Earth Boss", "IVARA": "Spy", "JADE": "Ascension", "KHORA": "Sanctuary Onslaught", "KULLERVO": "Duviri", "LAVOS": "Father", "MAG": "Phobos Boss", "MESA": "Mutalist Alad V", "NEKROS": "Deimos Boss", "NEZHA": "Dojo", "NIDUS": "Eris Salvage", "NOVA": "Europa Boss", "NYX": "Phorid", "OBERON": "Railjack", "PROTEA": "Granum Void", "QORVEX": "Sanctum Bounties", "REVENANT": "Cetus", "RHINO": "Venus Boss", "SARYN": "Sedna Boss", "SEVAGOTH": "Void Storms", "STYANAX": "Kahl", "TITANIA": "Quest", "TRINITY": "Pluto Boss", "VALKYR": "Jupiter Boss", "VAUBAN": "Nightwave", "VORUNA": "Lua Survival", "WISP": "Jupiter Boss", "WUKONG": "Dojo", "XAKU": "Deimos Bounties", "YARELI": "Ventkids", "ZEPHYR": "Dojo" };
    
    const DB_WEAPONS = { "IGNIS WRAITH": "Dojo", "BUBONICO": "Dojo", "CEDO": "Entrati", "PHENMOR": "Zariman", "LAETUM": "Zariman", "FELARX": "Zariman", "NATARUK": "Quest", "EPITAPH": "Void Storms" };

    let masteredNames = new Set();
    let ownedNames = new Set();
    let subsumedNames = new Set();
    let isLoaded = false;

    // Helper to clean names like "/Lotus/Types/Recipes/Weapons/Braton" -> "BRATON"
    function cleanName(str) {
        if (!str) return "";
        let parts = str.split('/');
        let name = parts[parts.length - 1].replace(/Item|Blueprint|Recipe/g, "").replace(/([A-Z])/g, ' $1').trim().toUpperCase();
        return name;
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = JSON.parse(event.target.result);
            
            // 1. Process Mastery
            if (data.mastery) {
                Object.keys(data.mastery).forEach(k => masteredNames.add(k.toUpperCase()));
            }

            // 2. Process Inventory (Look for both Name and Internal Path)
            const inv = data.inventory || data;
            if (Array.isArray(inv)) {
                inv.forEach(item => {
                    if (item.Name) ownedNames.add(item.Name.toUpperCase());
                    if (item.uniqueName) ownedNames.add(cleanName(item.uniqueName));
                });
            }

            // 3. Process Subsumes
            if (data.helminth?.subsumed) {
                data.helminth.subsumed.forEach(s => subsumedNames.add(s.toUpperCase()));
            }

            isLoaded = true;
            document.getElementById('fileStatus').innerText = "âœ… ACCOUNT SYNCED: " + masteredNames.size + " Mastered Items Detected";
            document.getElementById('fileStatus').style.color = "#2ea043";
        };
        reader.readAsText(e.target.files[0]);
    });

    function isItemFinished(name) {
        name = name.toUpperCase();
        // Check if user has regular, Prime, Vandal, Wraith, or Kuva version mastered
        const variants = [name, name + " PRIME", name + " VANDAL", name + " WRAITH", "KUVA " + name, "TENET " + name, name + " UMBRA"];
        return variants.some(v => masteredNames.has(v) || ownedNames.has(v));
    }

    function generateObjective() {
        let pool = [];

        // Check Frames
        for (let f in DB_FRAMES) {
            const finished = isItemFinished(f);
            const subsumed = subsumedNames.has(f);

            if (!finished) {
                pool.push({ cat: "Warframe Mastery", name: f, loc: DB_FRAMES[f], reason: "You don't have this or its Prime mastered.", weight: 100 });
            } else if (!subsumed && !f.includes("PRIME")) {
                pool.push({ cat: "Helminth", name: f, loc: DB_FRAMES[f], reason: "Mastered, but Helminth needs to eat this base version.", weight: 40 });
            }
        }

        // Check Weapons
        for (let w in DB_WEAPONS) {
            if (!isItemFinished(w)) {
                pool.push({ cat: "Weapon Mastery", name: w, loc: DB_WEAPONS[w], reason: "Missing Mastery.", weight: 30 });
            }
        }

        // Weighted Selection
        let weighted = [];
        pool.forEach(p => { for(let i=0; i<p.weight; i++) weighted.push(p); });
        const win = weighted[Math.floor(Math.random() * weighted.length)];

        if (!win) {
            document.getElementById('cName').innerText = "All Clear!";
            document.getElementById('cLoc').innerText = "System Charts";
            document.getElementById('cReason').innerText = "You own or have mastered everything in this database.";
        } else {
            document.getElementById('cCat').innerText = win.cat;
            document.getElementById('cName').innerText = win.name;
            document.getElementById('cLoc').innerText = win.loc;
            document.getElementById('cReason').innerText = win.reason;
        }
        document.getElementById('result').style.display = 'block';
    }
</script>
</body>
</html>
