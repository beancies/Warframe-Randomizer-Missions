<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenno Mission Roulette</title>
    <style>
        :root { --bg: #1a1a1a; --text: #e0e0e0; --accent: #00bcd4; --card: #2d2d2d; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        
        .container { max-width: 600px; width: 100%; text-align: center; }
        h1 { color: var(--accent); text-transform: uppercase; letter-spacing: 2px; }
        
        /* Upload Section */
        .upload-box { border: 2px dashed #444; padding: 20px; margin: 20px 0; border-radius: 8px; background: #222; }
        .upload-box p { font-size: 0.9em; color: #888; }
        
        /* Button */
        .btn-main {
            background: var(--accent); color: #000; font-weight: bold; font-size: 1.2rem;
            padding: 15px 40px; border: none; border-radius: 50px; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }
        .btn-main:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--accent); }
        .btn-main:disabled { background: #555; cursor: not-allowed; }

        /* Result Card */
        #mission-card {
            margin-top: 30px; background: var(--card); padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); display: none; border-left: 5px solid var(--accent);
        }
        .mission-type { font-size: 0.9em; text-transform: uppercase; color: #aaa; margin-bottom: 5px; }
        .mission-node { font-size: 1.5em; font-weight: bold; margin: 10px 0; }
        .mission-desc { color: #ccc; margin-bottom: 15px; }
        .tags { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .tag { background: #444; padding: 5px 10px; border-radius: 4px; font-size: 0.8em; }
        
        .log { margin-top: 20px; font-family: monospace; font-size: 0.8rem; color: #666; text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <h1>Tenno Roulette</h1>
    
    <div class="upload-box">
        <h3>1. Sync Inventory (Optional)</h3>
        <p>Export your data from AlecaFrame (Settings -> Export JSON) and drop it here to filter for items you actually need.</p>
        <input type="file" id="fileInput" accept=".json">
        <p id="fileStatus">No file loaded. Missions will be purely random.</p>
    </div>

    <button class="btn-main" id="rollBtn" onclick="generateMission()">GET MISSION</button>

    <div id="mission-card">
        <div class="mission-type" id="mType">VOID FISSURE</div>
        <div class="mission-node" id="mNode">Exterminate - Mars</div>
        <div class="mission-desc" id="mDesc">Loading...</div>
        <div class="tags" id="mTags"></div>
    </div>

    <div class="log" id="debugLog"></div>
</div>

<script>
    let userInventory = [];
    const logDiv = document.getElementById('debugLog');

    // Handle File Upload
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                // Try to parse AlecaFrame export
                const data = JSON.parse(e.target.result);
                // Aleca structure varies, we assume a list of items or a specific key
                // This is a "greedy" check for any array that looks like items
                if (Array.isArray(data)) userInventory = data; 
                else if (data.inventory) userInventory = data.inventory;
                
                document.getElementById('fileStatus').innerText = `âœ… Loaded ${userInventory.length || "some"} items.`;
                document.getElementById('fileStatus').style.color = "#00bcd4";
                log("Inventory loaded successfully.");
            } catch (err) {
                alert("Could not parse JSON. Make sure it's a valid AlecaFrame export.");
            }
        };
        reader.readAsText(file);
    });

    // Main Logic
    async function generateMission() {
        const btn = document.getElementById('rollBtn');
        const card = document.getElementById('mission-card');
        
        btn.disabled = true;
        btn.innerText = "Scanning System...";
        card.style.display = 'none';

        try {
            // 1. Fetch World State from Community API
            const response = await fetch('https://api.warframestat.us/pc');
            const ws = await response.json();

            // 2. Build a "Weighted Pool" of worthwhile missions
            let missionPool = [];

            // PRIORITY 1: Archon Hunt (If active)
            if (ws.archonHunt && !ws.archonHunt.expired) {
                missionPool.push({
                    type: "Archon Hunt",
                    node: ws.archonHunt.boss,
                    desc: "Weekly high-value target. Reward: Archon Shard.",
                    tags: ["Endgame", "Weekly"]
                });
            }

            // PRIORITY 2: Sortie
            if (ws.sortie && !ws.sortie.expired) {
                missionPool.push({
                    type: "Sortie",
                    node: ws.sortie.boss,
                    desc: "Daily 3-mission chain. High rewards.",
                    tags: ["Daily", "Riven Chance"]
                });
            }

            // PRIORITY 3: Void Fissures (The bread and butter)
            // If user uploaded inventory, we could filter tiers here, but for now we random all
            ws.fissures.forEach(f => {
                // Skip low value fissures sometimes? No, random is random.
                missionPool.push({
                    type: `${f.tier} Fissure`,
                    node: `${f.node} (${f.missionType})`,
                    desc: `Crack relics for Prime parts. Enemy: ${f.enemy}`,
                    tags: ["Prime Parts", "Ducats"]
                });
            });

            // PRIORITY 4: Invasions (Only if they have good loot like Potatoes/Forma)
            ws.invasions.forEach(inv => {
                const rewards = inv.attackerReward.itemString + inv.defenderReward.itemString;
                if (rewards.includes("Catalyst") || rewards.includes("Reactor") || rewards.includes("Forma")) {
                    missionPool.push({
                        type: "Invasion (High Value)",
                        node: inv.node,
                        desc: `Battle: ${inv.desc}. Reward: ${inv.attackerReward.asString} OR ${inv.defenderReward.asString}`,
                        tags: ["Rare Resource"]
                    });
                }
            });

            // 3. Pick a Winner
            if (missionPool.length === 0) {
                throw new Error("No interesting missions found. Go fishing?");
            }

            const mission = missionPool[Math.floor(Math.random() * missionPool.length)];

            // 4. Display
            document.getElementById('mType').innerText = mission.type;
            document.getElementById('mNode').innerText = mission.node;
            document.getElementById('mDesc').innerText = mission.desc;
            
            const tagsHtml = mission.tags.map(t => `<span class="tag">${t}</span>`).join('');
            document.getElementById('mTags').innerHTML = tagsHtml;

            card.style.display = 'block';

        } catch (error) {
            alert("Error fetching Warframe data: " + error.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "GET MISSION";
        }
    }

    function log(msg) {
        logDiv.innerText = "> " + msg;
    }
</script>

</body>
</html>
